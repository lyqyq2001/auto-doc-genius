"use strict";const{app:l,BrowserWindow:u,ipcMain:f}=require("electron"),s=require("path"),r=require("fs"),x=require("temp"),{convertWordToPdfWithOffice:y,checkWordInstallation:p}=require("./officeConverter");process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true";let d=null;const m=()=>{d=new u({width:800,height:600,webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:s.join(__dirname,"preload.js")}}),process.env.VITE_DEV_SERVER_URL?d.loadURL(process.env.VITE_DEV_SERVER_URL):d.loadFile(s.join(__dirname,"../dist/index.html"))};async function w(e){const t=[];try{if(!p())return{success:!1,error:"未检测到Microsoft Word安装"};for(const[o,n]of e.entries()){const a=x.mkdirSync("autodocgenius"),i=s.join(a,n.name),c=s.join(a,n.name.replace(".docx",".pdf"));try{if(r.writeFileSync(i,Buffer.from(n.buffer)),y(i,c)&&r.existsSync(c)){const h=r.readFileSync(c);t.push({name:n.name.replace(".docx",".pdf"),data:h})}else return{success:!1,error:`转换失败: ${n.name}`}}finally{r.existsSync(i)&&r.unlinkSync(i),r.existsSync(c)&&r.unlinkSync(c),r.existsSync(a)&&r.rmSync(a,{recursive:!0,force:!0})}}return{success:!0,results:t}}catch(o){return{success:!1,error:o.message}}}f.handle("batch-convert-pdf",async(e,t,o={})=>w(t));f.handle("check-office-installation",()=>p());f.handle("download-excel-template",async()=>{try{let e;const t=[s.join(__dirname,"../Excel Template.xls"),s.join(process.cwd(),"Excel Template.xls"),s.join(__dirname,"../../Excel Template.xls")];for(const n of t)if(r.existsSync(n)){e=n;break}if(!e)throw new Error("Excel模板文件未找到");return{success:!0,buffer:r.readFileSync(e).toString("base64"),filename:"Excel Template.xls"}}catch(e){return console.error("下载Excel模板失败:",e),{success:!1,error:e.message}}});f.handle("download-word-template",async()=>{try{let e;const t=[s.join(__dirname,"../Word Template.docx"),s.join(process.cwd(),"Word Template.docx"),s.join(__dirname,"../../Word Template.docx")];for(const n of t)if(r.existsSync(n)){e=n;break}if(!e)throw new Error("Word模板文件未找到");return{success:!0,buffer:r.readFileSync(e).toString("base64"),filename:"Word Template.docx"}}catch(e){return console.error("下载Word模板失败:",e),{success:!1,error:e.message}}});l.whenReady().then(m);l.on("window-all-closed",()=>{process.platform!=="darwin"&&l.quit()});l.on("activate",()=>{u.getAllWindows().length===0&&m()});
